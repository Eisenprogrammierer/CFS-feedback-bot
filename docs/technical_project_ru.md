# Технический проект бота для обратной связи

## I. Иерархическая структура папок и модулей
```
telegram_bot/
├── src/
│  ├── main.rs      # Точка входа приложения
│  ├── bot/        # Основные модули бота
│  │  ├── mod.rs     # Объявление модуля bot
│  │  ├── api_client.rs # Взаимодействие с Telegram Bot API
│  │  ├── message_router.rs # Маршрутизация входящих сообщений
│  │  ├── command_handler.rs # Обработка команд
│  │  ├── intent_recognizer.rs # Определение намерения пользователя
│  │  ├── dialog_manager.rs # Управление диалогом
│  │  ├── ai_agent.rs   # Взаимодействие с ИИ-агентом (Llama-3)
│  │  ├── models.rs   # Определения структур данных (User, Message, etc.)
│  │  ├── commands/   # Модули команд
│  │  │  ├── mod.rs   # Объявление модуля commands
│  │  │  ├── start.rs  # Команда /start
│  │  │  ├── help.rs  # Команда /help
│  │  │  └── ...    # Другие команды
│  ├── db/        # Модуль для работы с базой данных
│  │  ├── mod.rs     # Объявление модуля db
│  │  ├── connection.rs # Управление подключением к базе данных
│  │  ├── models.rs   # Модели данных для базы данных
│  │  ├── queries.rs   # SQL-запросы или ORM-операции
│  ├── events/      # Модуль для обработки событий
│  │  ├── mod.rs     # Объявление модуля events
│  │  ├── event_bus.rs  # Реализация шины событий
│  │  ├── handlers/   # Обработчики событий
│  │  │  ├── mod.rs   # Объявление модуля handlers
│  │  │  ├── dialog.rs # Обработчик событий диалога
│  │  │  └── ...    # Другие обработчики
│  ├── config/      # Модуль для управления конфигурацией
│  │  ├── mod.rs     # Объявление модуля config
│  │  ├── settings.rs  # Загрузка и хранение настроек
│  ├── nlp/        # Модуль для обработки естественного языка
│  │  ├── mod.rs     # Объявление модуля nlp
│  │  ├── intent.rs   # Модуль для определения намерения
│  │  ├── entity.rs   # Модуль для извлечения сущностей
│  ├── utils/       # Вспомогательные утилиты
│  │  ├── mod.rs     # Объявление модуля utils
│  │  ├── errors.rs   # Определения пользовательских ошибок
│  ├── main.rs
│  └── utils/
├── Cargo.toml     # Файл манифеста Rust
└── README.md      # Описание проекта
```
## II. Техническая спецификация модулей

### 1. src/main.rs

- **Ответственность:** Точка входа приложения.
- **Функциональность:**
  - Инициализация логгера.
  - Загрузка конфигурации.
  - Инициализация подключения к базе данных.
  - Создание экземпляра TelegramBotApiClient.
  - Запуск обработчика обновлений от Telegram Bot API.
- **Зависимости:** config, tracing, db, bot

### 2. src/bot/mod.rs

- **Ответственность:** Объявление модуля bot.
- **Функциональность:** Экспортирует все подмодули (api_client, message_router, command_handler, и т.д.).

### 3. src/bot/api_client.rs

- **Ответственность:** Взаимодействие с Telegram Bot API.
- **Функциональность:**
  - Инициализация клиента Telegram Bot API (используя teloxide или tbot).
  - Получение обновлений от Telegram Bot API (используя long polling или webhooks).
  - Отправка сообщений в Telegram.
  - Обработка ошибок, связанных с Telegram Bot API.
- **Зависимости:** teloxide или tbot, config

### 4. src/bot/message_router.rs

- **Ответственность:** Маршрутизация входящих сообщений.
- **Функциональность:**
  - Получение сообщений от TelegramBotApiClient.
  - Определение типа сообщения (команда, текст, и т.д.).
  - Направление сообщения соответствующему обработчику (Command Handler, Intent Recognizer).
- **Зависимости:** command_handler, intent_recognizer

### 5. src/bot/command_handler.rs

- **Ответственность:** Обработка команд (сообщения, начинающиеся с /).
- **Функциональность:**
  - Получение сообщений от MessageRouter.
  - Извлечение имени команды и аргументов.
  - Вызов соответствующего обработчика команды (например, start.rs, help.rs).
- **Зависимости:** commands, db, ai_agent

### 6. src/bot/commands/mod.rs

- **Ответственность:** Объявление модуля commands.
- **Функциональность:** Экспортирует все подмодули команд (start.rs, help.rs, и т.д.).

### 7. src/bot/commands/start.rs

- **Ответственность:** Обработка команды /start.
- **Функциональность:**
  - Приветствие пользователя.
  - Сохранение информации о пользователе в базе данных (если необходимо).
- **Зависимости:** db

### 8. src/bot/commands/help.rs

- **Ответственность:** Обработка команды /help.
- **Функциональность:**
  - Предоставление списка доступных команд и их описания.

### 9. src/bot/intent_recognizer.rs

- **Ответственность:** Определение намерения пользователя.
- **Функциональность:**
  - Получение сообщений от MessageRouter.
  - Использование модели NLP для определения намерения пользователя.
  - Возвращение намерения и извлеченных сущностей.
- **Зависимости:** nlp

### 10. src/bot/dialog_manager.rs

- **Ответственность:** Управление диалогом с пользователем.
- **Функциональность:**
  - Отслеживание текущего состояния диалога.
  - Определение следующего шага в диалоге.
  - Хранение информации о диалоге в базе данных (если необходимо).
- **Зависимости:** db, events

### 11. src/bot/ai_agent.rs

- **Ответственность:** Взаимодействие с ИИ-агентом (Llama-3).
- **Функциональность:**
  - Получение запросов от CommandHandler или DialogManager.
  - Формирование запроса для Llama-3.
  - Получение ответа от Llama-3.
  - Возвращение ответа пользователю.
- **Зависимости:** config, llama3 (или обертка для взаимодействия с вашей реализацией Llama-3)

### 12. src/db/mod.rs

- **Ответственность:** Объявление модуля db.
- **Функциональность:** Экспортирует подмодули для работы с базой данных (connection, models, queries).

### 13. src/db/connection.rs

- **Ответственность:** Управление подключением к базе данных.
- **Функциональность:**
  - Инициализация подключения к базе данных (PostgreSQL, MongoDB, SQLite).
  - Предоставление доступа к подключению другим модулям.
  - Обработка ошибок, связанных с подключением к базе данных.

### 14. src/db/models.rs

- **Ответственность:** Определение моделей данных для базы данных.
- **Функциональность:**
  - Определение структур данных для представления информации о пользователях, сообщениях, диалогах, и т.д.
  - Использование ORM (например, Diesel или SeaORM) для маппинга моделей данных на таблицы базы данных.

### 15. src/db/queries.rs

- **Ответственность:** Определение SQL-запросов или ORM-операций для взаимодействия с базой данных.
- **Функциональность:**
  - Выполнение запросов для получения, добавления, изменения и удаления данных.

### 16. src/events/mod.rs

- **Ответственность:** Объявление модуля events.
- **Функциональность:** Экспортирует подмодули для работы с событиями (event_bus, handlers).

### 17. src/events/event_bus.rs

- **Ответственность:** Реализация шины событий.
- **Функциональность:**
  - Регистрация обработчиков событий.
  - Публикация событий.
  - Оповещение зарегистрированных обработчиков о наступлении событий.

### 18. src/events/handlers/mod.rs

- **Ответственность:** Объявление модуля handlers.
- **Функциональность:** Экспортирует все подмодули обработчиков событий (dialog.rs, и т.д.).

### 19. src/events/handlers/dialog.rs

- **Ответственность:** Обработка событий, связанных с диалогом.
- **Функциональность:**
  - Реагирование на изменения состояния диалога.
  - Выполнение действий, связанных с изменением состояния диалога (например, отправка сообщения пользователю).

### 20. src/config/mod.rs

- **Ответственность:** Объявление модуля config.
- **Функциональность:** Экспортирует подмодули для работы с конфигурацией (settings.rs).

### 21. src/config/settings.rs

- **Ответственность:** Загрузка и хранение настроек приложения.
- **Функциональность:**
  - Чтение настроек из файла конфигурации (например, TOML, YAML).
  - Предоставление доступа к настройкам другим модулям.

### 22. src/nlp/mod.rs

- **Ответственность:** Объявление модуля nlp.
- **Функциональность:** Экспортирует подмодули для обработки естественного языка (intent, entity).

### 23. src/nlp/intent.rs

- **Ответственность:** Определение намерения пользователя.
- **Функциональность:**
  - Использование модели NLP для определения намерения пользователя.

### 24. src/nlp/entity.rs

- **Ответственность:** Извлечение сущностей из сообщения пользователя.
- **Функциональность:**
  - Использование модели NLP для извлечения сущностей.

### 25. src/utils/mod.rs

- **Ответственность:** Объявление модуля utils.
- **Функциональность:** Экспортирует подмодули для вспомогательных утилит (errors.rs).

### 26. src/utils/errors.rs

- **Ответственность:** Определение пользовательских ошибок.
- **Функциональность:**
  - Определение структуры ошибок для представления различных ошибок, которые могут возникнуть в приложении.

## III. Дополнительные соображения

- **Тестирование:** Модульные и интеграционные тесты для каждого модуля.
- **Документация:** Документирование каждого модуля и его функций.
- **Обработка ошибок:** Реализовать надёжную обработку ошибок.
- **Логирование:** Использовать систему логгирования.
